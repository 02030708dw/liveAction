//åŸŸåï¼šwss://hwdata-new.taxyss.com/ 
// 1.å‘é€å‚æ•°çš„tokenéœ€è¦åŠ å¯†ï¼ŒåŠ å¯†æ–¹å¼æ˜¯åŠ å¯†ä½ æ•´ä¸ªå‚æ•°{åŠ å¯†å‡½æ•°(JSON.stringify(i)),iæ˜¯ä½ çš„æ•´ä¸ªå‚æ•°ç»“æ„}ï¼Œå‘é€ä¹Ÿéœ€è¦è½¬æˆäºŒè¿›åˆ¶å†sendï¼Œå…·ä½“è¯·çœ‹è¯·æ±‚ç¤ºä¾‹æ–‡ä»¶ 
// 2.å›ä¼ å‚æ•°ä¸éœ€è¦è§£å¯†ï¼Œä½†æ˜¯éœ€è¦é‡æ–°ç»„è£…ä¸€ä¸‹æ•°æ®å› ä¸ºæ˜¯å­—èŠ‚ç ä¼ è¾“ï¼Œå…·ä½“ç»„è£…å’Œç»„è£…æ•°æ®æ¨¡å‹è¯·çœ‹ç¤ºä¾‹æ–‡ä»¶ ä¸€ï¼š æ¡æ‰‹æˆåŠŸä¹‹åè¿›å…¥æ¸¸æˆå¤§å…å…ˆè¦å‘é€10086ï¼Œ45ï¼Œ43ï¼Œ5011ï¼Œ87ï¼Œ24 è¿™å‡ ä¸ªè¯·æ±‚ç”¨äºåˆå§‹åŒ–å¤§å…å’Œç™»å½• 
// äºŒï¼š é“¾æ¥æˆåŠŸåï¼Œéœ€è¦é—´éš” 1~2ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆ99ï¼‰ 
// ä¸‰.ä¸‹æ³¨ï¼ˆ6ï¼‰ï¼Œä¸‹æ³¨ä¿¡æ¯éœ€è¦åŠ å¯†ï¼Œéœ€è¦ç”¨åˆ°10086çš„keyï¼Œå’Œæ•´ä½“çš„keyï¼Œè¯¦æƒ…è¯·çœ‹ç¤ºä¾‹æ–‡ä»¶,éœ€è¦æ ¹æ®1015æ‹¿åˆ°æœ€æ–°çš„seat,1002æ‹¿åˆ°æœ€æ–°çš„gameno æ¥å£å›ä¼ å‚æ•°è¯´æ˜ 
// 6ï¼šä¸‹æ³¨æˆåŠŸä¿¡æ¯ï¼šdListé‡Œé¢ç¬¬ä¸€ä¸ªæ˜¯ä½™é¢ä¿¡æ¯ 
// 24ï¼šå¯Œè±ªæ¦œcurrencyNameå¸ç§ï¼Œusernameï¼šç™»å½•è´¦å·ï¼Œonlineï¼šæ˜¯å¦åœ¨çº¿ï¼ŒuserLevelï¼šç©å®¶ç­‰çº§ 
// 43ï¼šå¤§å…æ¡Œå°æ€»è§ˆï¼Œåˆå§‹åŒ–å¤§å…çš„æ•°æ®ï¼Œroads=è·¯çº¸ï¼Œdealer=å½“å‰ç‰Œå±€è·å®˜ä¿¡æ¯ï¼ˆè·å®˜å°é¢åœ°å€host==https://new-dd-cloudfront.ywjxi.com/vd/vd/image/Image/dealer/ï¼‰æ¯ä¸ªæˆ¿é—´çš„totalAmountæ€»ä¸‹æ³¨é‡‘é¢ï¼ŒonlineCountåœ¨çº¿äººæ•°ç­‰ï¼Œåªç­‰æ³¨æ„çš„æ˜¯objectï¼ˆé‡Œå–å¼„æœ‰ä¸€ä¸ªtypeï¼Œå¦‚æœä¸‹æ³¨çš„æ—¶å€™æ¡Œå·æœ‰è¿™ä¸ªtypeéœ€è¦ç”¨åˆ°ï¼Œæ²¡æœ‰å°±ä¸º0ï¼‰gameNoè¿™æ˜¯æ¸¸æˆå±€ç¼–å·åé¢å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ï¼ŒgameIdæ¸¸æˆç±»å‹ï¼ŒtableIDæ¡Œå·ï¼› 
// 85ï¼šèŠå¤©ä¿¡æ¯: 
// 201ï¼šæ¡Œä¸Šç©å®¶ä¿¡æ¯ï¼šuserNameï¼šæ˜µç§°ï¼Œcurrencyï¼šå¸ç§ï¼Œbalanceï¼šä½™é¢ï¼ŒbetInfoï¼šå½“å‰ä¸‹æ³¨æ˜ç»†ï¼Œstreakï¼šè¿èƒœæ¬¡æ•°ï¼ŒbetNum / winNumï¼šä¸‹æ³¨/èƒœå±€ç»Ÿè®¡ï¼› 
// 207ï¼šæœ€æ–°çš„å„æ¡Œåœ¨çº¿äººæ•°å’ŒæŠ•æ³¨é¢ç»Ÿè®¡ã€‚å®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©æ€§åœ°ç”¨è¿™äº›æ•°æ®æ›´æ–°å¤§å…ç•Œé¢çš„çƒ­é—¨ç¨‹åº¦ã€ç­¹ç æ€»é‡æ˜¾ç¤ºç­‰ 
// 208ï¼šå½“å‰æ¡Œå°æ€»æŠ•æ³¨é¢ç»Ÿè®¡ï¼šbanker, player, tieï¼šå„æŠ•æ³¨åŒºæ€»é‡‘é¢ï¼ŒpPair, bPair, super6 ç­‰ï¼šå…¶ä»–ç©æ³•æŠ•æ³¨é‡‘é¢ï¼ŒbankerNum, playerNum ç­‰ï¼šç»Ÿè®¡å±€æ•° 
// 1002ï¼šå•æ¡Œå®æ—¶çŠ¶æ€,shoeId=é´å·ï¼ŒplayIdï¼šå±€å·ï¼Œstateï¼šçŠ¶æ€ï¼ˆ1=ä¸‹æ³¨ä¸­ï¼Œ2=å‘ç‰Œä¸­ï¼Œ5=ç»“ç®—ä¸­ç­‰ï¼‰ï¼ŒcountDownï¼šå‰©ä½™ç§’æ•°ï¼ˆä¸‹æ³¨å€’è®¡æ—¶ï¼‰ï¼Œpokerï¼šå½“å‰ç‰Œé¢ï¼ˆå°šæœªå¼€ç‰Œæ—¶ä¸º 0ï¼‰ï¼ŒgameNoï¼šå®Œæ•´ç‰Œå±€ç¼–å·ï¼Œpokerå‚æ•°ï¼šbankerï¼ˆåº„å®¶ç‰Œï¼‰ï¼Œplayerï¼ˆé—²å®¶ç‰Œï¼‰ 
// 1003ï¼šå¼€ç‰Œç»“æœï¼ˆä¼šå‘é€å‡ æ¬¡å¼€ç‰Œè¿‡ç¨‹ï¼‰ï¼Œå½“å‰å±€çš„å¼€ç‰Œç»“æœï¼›gameNoï¼šå½“å‰å±€å·ï¼ŒtableIdï¼šæ¡Œå·ï¼Œobjectï¼š player=é—²å®¶ï¼ˆPlayerï¼‰çš„ä¸‰å¼ ç‰Œç¼–ç ï¼Œbanker=åº„å®¶ï¼ˆBankerï¼‰çš„ä¸‰å¼ ç‰Œç¼–ç 
// 1004ï¼šè·¯çº¸ï¼šlistæ˜¯æ•°æ®ï¼Œå¦‚ã€#X#Y#Zã€‘å…¶ä¸­xè¡¨ç¤ºèƒœè´Ÿæ–¹ï¼ˆ1=åº„(Banker)ï¼Œ5=é—²(Player)ï¼Œ9=å’Œ(Tie)ï¼‰ï¼Œyè¡¨ç¤ºç‰¹æ®Šç±»å‹ï¼ˆ0=æ— ç‰¹æ®Šï¼Œ1=å‡ºç°å¯¹å­ï¼‰ï¼Œzç‚¹æ•°æˆ–é¡ºåºç¼–å·ï¼ˆé€šå¸¸ä¸ºåº„æˆ–é—²çš„ç‚¹æ•°ï¼Œä¹Ÿå¯è§†ä½œå±€åºå·ï¼‰ 
// 5014ï¼šæ¸¸æˆç»Ÿè®¡ã€èƒœç‡åˆ†æï¼šidå¯¹åº”ä¸åŒæˆ¿é—´/ç©æ³•,numsï¼šå±€æ•°ï¼Œwinsï¼šèµ¢å±€æ•°,type=0ï¼šå®æ—¶æ•°æ®ï¼Œtype=1ï¼šæ±‡æ€»æ•°æ®(ç”¨äºåˆ†æè¿‘20å±€çš„ä¸‹æ³¨ç©å®¶åå¥½) 
// 5015:æ¸¸æˆäº‹ä»¶ç”¨äºåˆ¤æ–­ç”¨æˆ·è¡Œä¸ºï¼Œæ¯”å¦‚è¿›å…¥ç‰Œå±€ï¼Œç¦»å¼€æˆ¿é—´ç­‰ç­‰ï¼Œtype=8è¿›å…¥ç‰Œå±€ï¼Œseatç©å®¶åº§ä½å·(ç”¨äºä¸‹æ³¨çš„roadTypeå‚æ•°å€¼),gameNoå’Œå¯¹åº”çš„tableIdï¼Œå¦‚æœå‘ç”Ÿäº†æ”¹å˜éœ€è¦è®°å½•ç”¨äºä¸‹æ³¨ 
// 10086ï¼šå›ä¼ å¤§å…ä¿¡æ¯ï¼Œä¸»è¦ç™»å½•ä¿¡æ¯å’Œä¸€äº›å…¬å‘Šï¼Œå’Œæ¸¸æˆçš„idç­‰æ•°æ®ï¼Œæœ‰ç”¨çš„ä¸»è¦æ˜¯tokenå’Œkeyï¼ˆå›ä¼ ç¤ºä¾‹é‡Œé¢çš„ 'list' é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºåé¢æ¸¸æˆä¸‹æ³¨çš„åŠ å¯†ï¼‰ï¼Œusername;

import { defineStore } from 'pinia';
import CryptoJS from 'crypto-js';
import type { PushState, UiTable } from '@/utils/dgProto';
import {
    decodeDgMsgVm86,
    PublicBean,
    buildUiTableData,
    extractUserNameFromMapped,
} from '@/utils/dgDebugDecode';
import { useAuthStore } from './dgAuth';

interface State {
    token: string;
    wskey: string;
    mid: string;
    tableId: number;
    type: number;

    ws: WebSocket | null;
    connected: boolean;
    status: string;
    logs: string[];

    pushState: PushState;
    uiTables: UiTable[];

    pushTimer: number | null;
    heartbeatTimer: number | null;
    countdownTimer: number | null;

    /** æ¸¸æˆ WS é‡è¿å®šæ—¶å™¨ */
    gameReconnectTimer: number | null;
    /** æ¸¸æˆ WS æ˜¯å¦åœæ­¢é‡è¿ï¼ˆé¡µé¢é€€å‡ºæ—¶ç½® trueï¼‰ */
    gameStopped: boolean;
    /** æ¸¸æˆ WS è¿æ¥åºå·ï¼ˆé˜²æ­¢æ—§ onclose è¯¯ä¼¤ï¼‰ */
    gameConnSeq: number;

    /** 10086.list[0]ï¼Œä¸‹æ³¨åŠ å¯†ç”¨ */
    random: string;
    /** ä¸‹æ³¨ç›¸å…³ */
    userName: string;
    betEncryptKey: string;

    /** 43.object è§£æåï¼ŒæŒ‰ tableId å­˜ type / count */
    dgObjectByTableId: Record<number, { type: number; count: number }>;
    /** 1002 / 5015 / 1015 çš„æœ€æ–° gameNo / seatï¼ŒæŒ‰ tableId å­˜ */
    dgRuntimeByTableId: Record<number, { gameNo?: string; seat?: number }>;
}

/** ================= æ¨é€ç»™åç«¯çš„ WS é…ç½® ================= */
const PUSH_WS_URL = 'wss://phpclienta.nakiph.xyz/ws/getTableInfos';
// const PUSH_WS_URL = 'wss://phpclientd.nakiph.xyz/ws/getTableInfos';

let wsPush: WebSocket | null = null;
let pushQueue: string[] = [];
let pushReconnectTimer: number | null = null;
let pushStopped = false;
// let pushConnSeq = 0;

const PUSH_RECONNECT_DELAY = 5000;
const MAX_PUSH_QUEUE = 50;
/** ===================================================== */

const DEALER_IMG_HOST =
    'https://new-dd-cloudfront.ywjxi.com/vd/vd/image/Image/dealer/';

const EVENT_STATUS_TEXT: Record<string, string> = {
    GP_NEW_GAME_START: 'æ–°å±€å¼€å§‹ / ä¸‹æ³¨ä¸­',
    GP_BETTING: 'ä¸‹æ³¨ä¸­',
    GP_DEALING: 'å‘ç‰Œä¸­',
    GP_SETTLEMENT: 'ç»“ç®—ä¸­',
    GP_RESULT: 'ç»“æœå±•ç¤º',
};

const GAME_RECONNECT_DELAY = 5000;

export function resolveStatus(tableInfo: any, dealerEvent: any) {
    if (tableInfo.maintenance) {
        return {
            text: 'ç»´æŠ¤ä¸­',
            className: 'status-pill status-pill--maintenance',
        };
    }
    if (dealerEvent.shuffle || tableInfo.shuffle) {
        return {
            text: 'æ´—ç‰Œä¸­',
            className: 'status-pill status-pill--shuffle',
        };
    }
    const t =
        EVENT_STATUS_TEXT[dealerEvent.eventType] ||
        dealerEvent.eventType ||
        'æœªçŸ¥çŠ¶æ€';
    return { text: t, className: 'status-pill' };
}

/** è§£æ cmd=43 é‡Œçš„ object å­—ç¬¦ä¸² -> æŒ‰ tableId æ˜ å°„ */
function parseDgObjectByTableId(
    objStr?: string | null,
): Record<number, { type: number; count: number }> {
    if (!objStr) return {};
    try {
        const raw = JSON.parse(objStr) as Record<
            string,
            { type?: number; count?: number }
        >;
        const map: Record<number, { type: number; count: number }> = {};
        for (const [idStr, v] of Object.entries(raw)) {
            if (!v || typeof v.type !== 'number') continue;
            const id = Number(idStr);
            if (!Number.isFinite(id)) continue;
            map[id] = { type: v.type, count: v.count ?? 0 };
        }
        return map;
    } catch (e) {
        console.warn('[DG] parseDgObjectByTableId å¤±è´¥', e, objStr);
        return {};
    }
}

/** æ¨é€ WSï¼šå®‰æ’ç®€å•é‡è¿ï¼ˆæ–­å¼€ -> 5s -> connect ä¸€æ¬¡ï¼‰ */
function schedulePushReconnect(ctx: any, delay = PUSH_RECONNECT_DELAY) {
    if (pushStopped) return;
    if (pushReconnectTimer) return;
    pushReconnectTimer = window.setTimeout(() => {
        pushReconnectTimer = null;
        ctx.connectPushWS();
    }, delay);
}

export const useDgWsStore = defineStore('dgWs', {
    state: (): State => ({
        token: '',
        wskey:
            'pV5mY8dR2qGxH1sK9tBzN6uC3fWjE0aL7rTnJ4cQvSgPZyFMiXoUbDlAhOeRwd36',
        mid: '99',
        tableId: 1,
        type: 0,

        ws: null,
        connected: false,
        status: '',
        logs: [],

        pushState: {
            list: [],
            table: [],
            tableStateById: {},
            roadsByTableId: {},
            playersByTableId: {},
            betAreaByTableId: {},
            statsByTableId: {},
            chatByTableId: {},
            eventsByTableId: {},
            betResultByTableId: {},
            richList: [],
            openCardByTableId: {},
            countdownByTableId: {},
        },
        uiTables: [],

        pushTimer: null,
        heartbeatTimer: null,
        countdownTimer: null,

        gameReconnectTimer: null,
        gameStopped: false,
        gameConnSeq: 0,

        random: '',
        userName: '',
        betEncryptKey: '',

        dgObjectByTableId: {},
        dgRuntimeByTableId: {},
    }),

    getters: {
        /** æœ€æ–° gameNoï¼ˆæ¥è‡ª 1002 / 5015 / 1015ï¼‰ï¼ŒæŒ‰ tableId */
        dgGameNoForBet: (state) => (tableId: number): string => {
            return state.dgRuntimeByTableId[tableId]?.gameNo ?? '';
        },
        /** æœ€æ–° seatï¼ˆä¸»è¦æ¥è‡ª 5015 / 1015ï¼‰ï¼ŒæŒ‰ tableIdï¼Œç”¨ä½œ roadType */
        dgSeatForBet: (state) => (tableId: number): number => {
            return state.dgRuntimeByTableId[tableId]?.seat ?? 0;
        },
        /** 43.object é‡Œå¯¹åº”æ¡Œå­çš„ typeï¼Œå¤‡ç”¨ */
        dgObjectTypeForTable: (state) => (tableId: number): number => {
            return state.dgObjectByTableId[tableId]?.type ?? 0;
        },
    },

    actions: {
        initFromAuth() {
            const authStore = useAuthStore();
            this.token = authStore.gameToken || authStore.auth?.accessToken || '';
            this.wskey =
                authStore.wskey ||
                'pV5mY8dR2qGxH1sK9tBzN6uC3fWjE0aL7rTnJ4cQvSgPZyFMiXoUbDlAhOeRwd36';
        },

        setWsConfig(payload: {
            token?: string;
            wskey?: string;
            mid?: string;
            tableId?: number;
            type?: number;
        }) {
            if (payload.token !== undefined) this.token = payload.token;
            if (payload.wskey !== undefined) this.wskey = payload.wskey;
            if (payload.mid !== undefined) this.mid = payload.mid;
            if (payload.tableId !== undefined) this.tableId = payload.tableId;
            if (payload.type !== undefined) this.type = payload.type;
        },

        log(msg: string) {
            this.logs.push(msg);
            if (this.logs.length > 200) this.logs.shift();
        },

        getEncryptToken(str: string): string {
            const key = CryptoJS.enc.Utf8.parse(this.wskey.trim());
            const enc = CryptoJS.TripleDES.encrypt(str, key, {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7,
            });
            return enc.toString();
        },

        buildPacket(cmd: number, extra: Partial<any> = {}): Uint8Array {
            const token = this.token.trim();
            const mid = this.mid.trim();
            const tableId = this.tableId;
            const type = this.type;

            const envelope = { cmd, token, time: Date.now() };
            const encToken = this.getEncryptToken(JSON.stringify(envelope));

            let payload: any = null;
            if (cmd !== 6) {
                payload = {
                    cmd,
                    token: encToken,
                    codeId: 0,
                    lobbyId: 0,
                    gameNo: '',
                    seat: 0,
                    tableId,
                    mid,
                    dList: [],
                    type,
                    userName: '',
                    list: [],
                    mids: [],
                    object: cmd === 10086 ? 'PC' : '',
                    ...extra,
                };
            } else {
                payload = { cmd, token: encToken, ...extra };
            }

            return PublicBean.encode(payload).finish() as Uint8Array;
        },

        sendPacket(cmd: number, extra: Partial<any> = {}) {
            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                console.warn('WS æœªè¿æ¥');
                return;
            }
            const buf = this.buildPacket(cmd, extra);
            this.ws.send(buf);
        },

        sendInitSeq() {
            const seq = [
                { cmd: 10086, tableId: this.tableId, type: 0, object: 'PC' },
                { cmd: 45, type: 1 },
                { cmd: 43, tableId: this.tableId, type: 0 },
                { cmd: 5011, type: 0 },
                { cmd: 87, type: 1 },
                { cmd: 24, type: 2 },
            ];
            (async () => {
                this.log('ğŸš€ åˆå§‹åŒ–åºåˆ—å¼€å§‹...');
                for (const pkt of seq) {
                    const buf = this.buildPacket(pkt.cmd, pkt);
                    this.ws?.send(buf);
                    await new Promise((r) => setTimeout(r, 300));
                }
                this.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            })();
        },

        startHeartbeat() {
            if (this.heartbeatTimer) return;
            this.heartbeatTimer = window.setInterval(() => {
                this.sendPacket(99);
            }, 2000);
        },

        stopHeartbeat() {
            if (this.heartbeatTimer) {
                clearInterval(this.heartbeatTimer);
                this.heartbeatTimer = null;
            }
        },

        startCountdownTimer() {
            if (this.countdownTimer) return;
            this.countdownTimer = window.setInterval(() => {
                this.rebuildUiTables();
            }, 1000);
        },

        stopCountdownTimer() {
            if (this.countdownTimer) {
                clearInterval(this.countdownTimer);
                this.countdownTimer = null;
            }
        },

        /** æ¸¸æˆ WSï¼šå®‰æ’ç®€å•é‡è¿ï¼ˆæ–­å¼€ -> 5s -> connect ä¸€æ¬¡ï¼‰ */
        scheduleGameReconnect(delay = GAME_RECONNECT_DELAY) {
            if (this.gameStopped) return;
            if (this.gameReconnectTimer) return;
            this.gameReconnectTimer = window.setTimeout(() => {
                this.gameReconnectTimer = null;
                this.connect();
            }, delay);
        },

        /** è¿æ¥æ¸¸æˆ WSï¼ˆä¿è¯å•å®ä¾‹ + æ–­å¼€åç®€å•é‡è¿ï¼‰ */
        connect() {
            if (!this.token || !this.wskey) {
                this.log('token æˆ– wskey ä¸ºç©º');
                return;
            }

            // âœ… å·²è¿/æ­£åœ¨è¿ï¼šä¸è¦é‡å¤ newï¼ˆé¿å…å¤šä¸ªè¿æ¥ï¼‰
            if (
                this.ws &&
                (this.ws.readyState === WebSocket.OPEN ||
                    this.ws.readyState === WebSocket.CONNECTING)
            ) {
                return;
            }

            this.gameStopped = false;

            // æ¸…ç†æ—§çš„é‡è¿å®šæ—¶å™¨
            if (this.gameReconnectTimer) {
                clearTimeout(this.gameReconnectTimer);
                this.gameReconnectTimer = null;
            }

            const sign = this.getEncryptToken(this.token.trim());
            const url = `wss://hwdata-new.taxyss.com/?sign=${sign}`;
            this.log(`è¿æ¥åˆ°: ${url}`);

            // const seq = ++this.gameConnSeq;
            const ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';

            this.ws = ws;

            ws.onopen = () => {
                // âœ… åªå¤„ç†â€œå½“å‰è¿™æ¡â€è¿æ¥
                if (ws !== this.ws || this.gameStopped) return;

                this.log('âœ… å·²è¿æ¥');
                this.status = 'å·²è¿æ¥';
                this.connected = true;

                this.startHeartbeat();
                this.startCountdownTimer();

                // æ¸¸æˆ WS è¿ä¸Šæ—¶é¡ºä¾¿è¿ä¸Šæ¨é€ WS
                this.connectPushWS();

                setTimeout(() => {
                    // å†æ¬¡ç¡®è®¤ä»ç„¶æ˜¯å½“å‰è¿æ¥
                    if (ws !== this.ws || this.gameStopped) return;
                    this.sendInitSeq();
                }, 1000);
            };

            ws.onclose = (e) => {
                // âœ… è€è¿æ¥å…³é—­ä¸å½±å“æ–°è¿æ¥
                if (ws !== this.ws) return;

                this.log(`ğŸ”Œ è¿æ¥å…³é—­ code=${e.code} reason=${e.reason}`);
                this.status = 'è¿æ¥å…³é—­';
                this.connected = false;

                this.stopHeartbeat();
                this.stopCountdownTimer();

                this.ws = null;

                // âœ… ç®€å•é‡è¿
                this.scheduleGameReconnect();
            };

            ws.onerror = () => {
                // ç®€åŒ–ï¼šå‡ºé”™å°± closeï¼Œè®© onclose ç»Ÿä¸€èµ°â€œ5såé‡è¿â€
                try {
                    ws.close();
                } catch { }
            };

            ws.onmessage = (e) => this.handleMessage(e.data);
        },

        /** ä»…å…³é—­æ¸¸æˆ WSï¼ˆä¸åœæ­¢é‡è¿çš„è¯ï¼Œå®ƒä¼š 5s åå†è¿ï¼‰ */
        close() {
            try {
                this.ws?.close();
            } catch { }
        },

        /** é¡µé¢é€€å‡ºå»ºè®®è°ƒç”¨ï¼šåœæ­¢é‡è¿ + å…³é—­æ¸¸æˆWS + å…³é—­æ¨é€WS + æ¸…ç†å®šæ—¶å™¨ */
        closeAll() {
            // stop game reconnect
            this.gameStopped = true;
            if (this.gameReconnectTimer) {
                clearTimeout(this.gameReconnectTimer);
                this.gameReconnectTimer = null;
            }

            // stop timers
            this.stopHeartbeat();
            this.stopCountdownTimer();

            // close game ws
            if (this.ws) {
                const ws = this.ws;
                this.ws = null;
                try {
                    ws.close();
                } catch { }
            }

            // stop push reconnect + close push ws
            this.closePushWS();
        },

        /** æ¸¸æˆ WS æ”¶åˆ°æ¶ˆæ¯ */
        handleMessage(data: ArrayBuffer | Blob) {
            try {
                const arrBuf =
                    data instanceof ArrayBuffer
                        ? data
                        : (data as Blob).slice(0).arrayBuffer();

                if (arrBuf instanceof Promise) {
                    arrBuf.then((ab) => this._handleDecoded(new Uint8Array(ab), data));
                } else {
                    this._handleDecoded(new Uint8Array(arrBuf), arrBuf);
                }
            } catch {
                // è§£ç é”™è¯¯ç›´æ¥å¿½ç•¥
            }
        },

        _handleDecoded(u8: Uint8Array, _rawData: any) {
            const mapped = decodeDgMsgVm86(u8);
            const cmd = mapped.cmd | 0;
            const tableId = (mapped as any).tableId || (mapped as any).tableID || 0;

            switch (cmd) {
                case 10086: {
                    this.pushState.list = Array.isArray(mapped.list) ? mapped.list : [];

                    const extracted = extractUserNameFromMapped(mapped);
                    if (extracted) {
                        this.userName = extracted;
                    } else {
                        const authStore = useAuthStore();
                        this.userName = authStore.userName || '';
                    }

                    const entries = (this.pushState.list || [])
                        .map((x: any) => (x == null ? '' : String(x)))
                        .filter((s: string) => s.length > 0);

                    if (entries.length > 1) this.betEncryptKey = entries[1]!;
                    else if (entries.length === 1) this.betEncryptKey = entries[0]!;

                    this.log(
                        `ğŸ² cmd=10086 userName=${this.userName} betEncryptKey=${this.betEncryptKey} list=${JSON.stringify(
                            this.pushState.list,
                        )}`,
                    );

                    this.schedulePush();
                    break;
                }

                case 43: {
                    this.pushState.table = Array.isArray(mapped.table) ? mapped.table : [];
                    this.dgObjectByTableId = parseDgObjectByTableId(mapped.object);
                    this.schedulePush();
                    break;
                }

                case 1002: {
                    if (Array.isArray(mapped.table)) {
                        for (const t of mapped.table) {
                            const tid = Number(t.tableId || t.tableID);
                            if (!tid) continue;

                            this.pushState.tableStateById[tid] = t;

                            if (t.gameNo) {
                                const rt = (this.dgRuntimeByTableId[tid] ??= {});
                                rt.gameNo = t.gameNo;
                            }

                            if (t.state === 1 && typeof t.countDown === 'number') {
                                this.pushState.countdownByTableId[tid] = {
                                    base: t.countDown,
                                    lastUpdate: Date.now(),
                                    active: true,
                                };
                            } else {
                                this.pushState.countdownByTableId[tid] = {
                                    base: 0,
                                    lastUpdate: Date.now(),
                                    active: false,
                                };
                            }
                        }
                        this.schedulePush();
                    }
                    break;
                }

                case 1004:
                    this.handleLobbyPush1004(mapped);
                    break;

                case 201:
                    this.handleTableArrayLike(mapped, 'playersByTableId');
                    break;

                case 207:
                    this.handleLobbyPush207(mapped);
                    break;

                case 208:
                    this.handleTableArrayLike(mapped, 'betAreaByTableId');
                    break;

                case 5014:
                    this.handleTableArrayLike(mapped, 'statsByTableId');
                    break;

                case 85:
                    if (tableId) {
                        this.pushState.chatByTableId[tableId] = mapped;
                        this.schedulePush();
                    }
                    break;

                case 5015: {
                    if (tableId) {
                        this.pushState.eventsByTableId[tableId] = mapped;

                        const rt = (this.dgRuntimeByTableId[tableId] ??= {});
                        if (typeof mapped.seat === 'number') rt.seat = mapped.seat;
                        if (mapped.gameNo) rt.gameNo = mapped.gameNo;

                        this.schedulePush();
                    }
                    break;
                }

                case 6:
                    if (tableId) {
                        this.pushState.betResultByTableId[tableId] = mapped;
                        this.schedulePush();
                    }
                    break;

                case 24:
                    this.pushState.richList = Array.isArray(mapped.list) ? mapped.list : [];
                    this.schedulePush();
                    break;

                case 1003:
                    if (tableId && mapped.gameNo) {
                        if (!this.pushState.openCardByTableId[tableId]) {
                            this.pushState.openCardByTableId[tableId] = {};
                        }
                        this.pushState.openCardByTableId[tableId][mapped.gameNo] = mapped;
                        this.schedulePush();
                    }
                    break;

                case 1015: {
                    if (tableId) {
                        const rt = (this.dgRuntimeByTableId[tableId] ??= {});
                        if (typeof mapped.seat === 'number') rt.seat = mapped.seat;
                        if (mapped.gameNo) rt.gameNo = mapped.gameNo;
                    }
                    break;
                }

                default:
                    break;
            }
        },

        handleTableArrayLike(mapped: any, field: keyof PushState) {
            const arr = Array.isArray(mapped.table) ? mapped.table : [];
            for (const t of arr) {
                const tid = Number(t.tableId || t.tableID);
                if (!tid) continue;
                // @ts-ignore
                this.pushState[field][tid] = t;
            }
            this.schedulePush();
        },

        handleLobbyPush1004(mapped: any) {
            const tid = mapped.tableId || mapped.tableID;
            if (!tid) return;

            if (Array.isArray(this.pushState.table)) {
                const summary = (this.pushState.table as any[]).find(
                    (x) => Number(x.tableId || x.tableID) === tid,
                );
                if (summary) summary.roads = mapped.list;
            }
            this.pushState.roadsByTableId[tid] = mapped.list;
            this.schedulePush();
        },

        handleLobbyPush207(mapped: any) {
            const arr = Array.isArray(mapped.lobbyPush) ? mapped.lobbyPush : [];
            if (!arr.length || !Array.isArray(this.pushState.table)) return;

            for (const lp of arr) {
                const tid = Number(lp.tableId || lp.tableID);
                if (!tid) continue;

                const t = (this.pushState.table as any[]).find(
                    (x) => Number(x.tableId || x.tableID) === tid,
                );
                if (!t) continue;

                t.onlineCount = lp.onlineCount ?? t.onlineCount ?? 0;
                t.totalAmount = lp.totalAmount ?? t.totalAmount ?? 0;
                t.vipName = lp.vipName ?? t.vipName ?? '';
                t.seatFull = lp.seatFull ?? t.seatFull ?? false;
            }
            this.schedulePush();
        },

        /** ğŸ” èŠ‚æµï¼šåˆå¹¶ UI é‡å»º + æ¨é€åˆ°åç«¯ */
        schedulePush() {
            if (this.pushTimer) return;
            this.pushTimer = window.setTimeout(() => {
                this.pushTimer = null;
                this.rebuildUiTables();
                this.pushCombined();
            }, 500);
        },

        /** ç”¨ pushState é‡å»ºæ‰€æœ‰æ¡Œå°çš„ UI æ•°æ® */
        rebuildUiTables() {
            const tables = Array.isArray(this.pushState.table) ? this.pushState.table : [];
            const ui: UiTable[] = [];
            for (const t of tables) {
                const tid = Number(t.tableId || t.tableID);
                if (!tid) continue;
                const row = buildUiTableData(tid, this.pushState);
                if (row) ui.push(row);
            }
            this.uiTables = ui;
        },

        dealerImageUrl(image: string) {
            return DEALER_IMG_HOST + (image || 'default.png');
        },

        clearLogs() {
            this.logs = [];
        },

        /** ================= æ¨é€ WS ç›¸å…³ï¼ˆå•å®ä¾‹ + ç®€å•é‡è¿ï¼‰ ================= */

        connectPushWS() {
            pushStopped = false;

            // âœ… å·²è¿/æ­£åœ¨è¿ï¼šä¸è¦é‡å¤ new
            if (
                wsPush &&
                (wsPush.readyState === WebSocket.OPEN ||
                    wsPush.readyState === WebSocket.CONNECTING)
            ) {
                return;
            }

            // æ¸…ç†æ—§çš„é‡è¿å®šæ—¶å™¨
            if (pushReconnectTimer) {
                clearTimeout(pushReconnectTimer);
                pushReconnectTimer = null;
            }

            // const seq = ++pushConnSeq;
            const ws = new WebSocket(PUSH_WS_URL);
            wsPush = ws;

            ws.onopen = () => {
                // âœ… åªå¤„ç†â€œå½“å‰è¿™æ¡â€è¿æ¥
                if (ws !== wsPush || pushStopped) return;

                if (pushQueue.length && ws.readyState === WebSocket.OPEN) {
                    for (const msg of pushQueue) ws.send(msg);
                    pushQueue = [];
                }
            };

            ws.onclose = () => {
                // âœ… è€è¿æ¥å…³é—­ä¸å½±å“æ–°è¿æ¥
                if (ws !== wsPush) return;

                wsPush = null;
                schedulePushReconnect(this);
            };

            ws.onerror = () => {
                // ç®€åŒ–ï¼šå‡ºé”™å°± closeï¼Œè®© onclose ç»Ÿä¸€èµ°â€œ5såé‡è¿â€
                try {
                    ws.close();
                } catch { }
            };
        },

        /** é¡µé¢é€€å‡ºæ—¶è°ƒç”¨ï¼šå½»åº•åœæ­¢æ¨é€é‡è¿å¹¶å…³é—­æ¨é€ WS */
        closePushWS() {
            pushStopped = true;

            if (pushReconnectTimer) {
                clearTimeout(pushReconnectTimer);
                pushReconnectTimer = null;
            }

            if (wsPush) {
                const ws = wsPush;
                wsPush = null;
                try {
                    ws.close();
                } catch { }
            }

            pushQueue = [];
        },

        ensurePushWS(): boolean {
            if (wsPush?.readyState === WebSocket.OPEN) return true;
            this.connectPushWS(); // åªä¼šåœ¨é OPEN/CONNECTING æ—¶ new
            return false;
        },

        /** æ¨é€ç»™åç«¯ */
        pushCombined() {
            const payload = {
                type: 'dgGameTableInfos',
                data: this.uiTables,
            };
            const text = JSON.stringify(payload);

            if (this.ensurePushWS()) {
                wsPush!.send(text);
            } else {
                pushQueue.push(text);
                if (pushQueue.length > MAX_PUSH_QUEUE) pushQueue.shift();
            }
        },

        /** ================= æŠ•æ³¨ç›¸å…³ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰ ================= */

        enterRoom(tableId: number, gameNo: string) {
            this.sendPacket(29, { tableId, type: 1 });
            this.sendPacket(9, { tableId, gameNo });
            this.sendPacket(44, { tableId, mid: '0' });
            this.sendPacket(19, { tableId, type: 1 });
            this.sendPacket(4, { tableId, type: 1, seat: -1 });
        },

        normalizeTripleDesKey(rawKey: string): CryptoJS.lib.WordArray {
            const encoder = new TextEncoder();
            const source = encoder.encode(rawKey);

            let keyBytes: Uint8Array;
            if (source.length === 0) {
                keyBytes = new Uint8Array(24);
            } else if (source.length === 24) {
                keyBytes = source;
            } else if (source.length > 24) {
                keyBytes = source.slice(0, 24);
            } else {
                keyBytes = new Uint8Array(24);
                for (let i = 0; i < 24; i++) keyBytes[i] = source[i % source.length]!;
            }

            const words: number[] = [];
            for (let i = 0; i < keyBytes.length; i += 4) {
                words.push(
                    (keyBytes[i]! << 24) |
                    (keyBytes[i + 1]! << 16) |
                    (keyBytes[i + 2]! << 8) |
                    keyBytes[i + 3]!,
                );
            }

            return CryptoJS.lib.WordArray.create(words, keyBytes.length);
        },

        dgEncryptToken(plainText: string, keyStr: string): string {
            const key = this.normalizeTripleDesKey(keyStr);
            const enc = CryptoJS.TripleDES.encrypt(plainText, key, {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7,
            });
            return enc.toString();
        },

        normalizeBetKey(source: string): string {
            if (!source) return source;
            if (source.length === 1) return source.toLowerCase();
            return source[0]!.toLowerCase() + source.slice(1);
        },

        buildSingleBetData(params: {
            key: string;
            amount: number;
            table: string;
            roadType: string;
        }): any {
            const betData: any = {};
            const normKey = this.normalizeBetKey(params.key.trim());
            if (!normKey || !params.amount || params.amount <= 0) {
                throw new Error('æ— æ•ˆçš„ä¸‹æ³¨ key æˆ– amount');
            }
            betData[normKey] = params.amount;
            betData.info = JSON.stringify({
                table: params.table,
                roadType: params.roadType,
            });
            return betData;
        },

        sendDgBet(params: { tableId: number; gameNo: string; betData: any }) {
            if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                this.log('âŒ WS æœªè¿æ¥ï¼Œæ— æ³•æŠ•æ³¨');
                alert('WS æœªè¿æ¥ï¼Œæ— æ³•æŠ•æ³¨');
                return;
            }

            const { tableId, gameNo, betData } = params;

            const userName = this.userName;
            if (!userName) throw new Error('userName ä¸ºç©ºï¼Œè¯·ç¡®è®¤å·²æ”¶åˆ° cmd=10086');

            const betKey = this.betEncryptKey;
            if (!betKey) throw new Error('betEncryptKey ä¸ºç©ºï¼Œè¯·ç¡®è®¤å·²æ”¶åˆ° cmd=10086');

            const keyLen = betKey.length;
            const suffixKey = keyLen > 8 ? betKey.slice(8, Math.min(16, keyLen)) : betKey;

            const hashInput = String(tableId) + gameNo + userName + suffixKey;
            const md5 = CryptoJS.MD5(hashInput).toString();

            const encBetData = this.dgEncryptToken(JSON.stringify(betData), betKey);
            const list = ['1', md5, encBetData];

            this.log(
                `ğŸ§® sendDgBet: tableId=${tableId}, gameNo=${gameNo}, userName=${userName}, suffixKey=${suffixKey}, md5=${md5}`,
            );

            this.sendPacket(6, {
                tableId,
                gameNo,
                type: 1,
                list,
            });

            this.log(`ğŸ“¤ å‘é€ä¸‹æ³¨ cmd=6, payload.list=${JSON.stringify(list)}`);
        },

        placeSingleBet(params: {
            tableId: number;
            betKey: string;
            amount: number;
            gameNo?: string;
            roadType?: number;
            tableIndex?: number;
        }) {
            const tableId = params.tableId;

            const gameNo = this.dgGameNoForBet(tableId) ?? params.gameNo;
            if (!gameNo) {
                throw new Error(
                    `æ‰¾ä¸åˆ° tableId=${tableId} çš„ gameNoï¼Œè¯·ç¡®è®¤å·²æ”¶åˆ° 1002/5015/1015`,
                );
            }

            const roadTypeNum = this.dgSeatForBet(tableId);
            const tableStr = String(params.tableIndex ?? 3);
            const roadTypeStr = String(roadTypeNum);

            const betData = this.buildSingleBetData({
                key: params.betKey,
                amount: params.amount,
                table: tableStr,
                roadType: roadTypeStr,
            });

            this.enterRoom(tableId, gameNo);
            setTimeout(() => {
                this.sendDgBet({ tableId, gameNo, betData });
            }, 100);
        },
    },
});
