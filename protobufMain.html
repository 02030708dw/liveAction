<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>DG 协议解码器 v20（增强兼容性）</title>
<style>
body{background:#0d1117;color:#e6edf3;font-family:Consolas,monospace;margin:0;padding:20px;}
h2{color:#79c0ff;}
textarea{width:100%;height:150px;background:#161b22;border:1px solid #30363d;color:#c9d1d9;border-radius:8px;padding:10px;}
button{background:#238636;color:white;border:none;padding:8px 14px;border-radius:6px;margin-top:10px;cursor:pointer;}
button:hover{filter:brightness(1.1);}
pre{background:#161b22;border-radius:8px;padding:12px;white-space:pre-wrap;word-break:break-all;}
.ok{color:#3fb950}.err{color:#f85149}
</style>
</head>
<body>

<h2>DG 协议解码器 v20（增强兼容性）</h2>

<textarea id="b64" placeholder="在此粘贴 Base64 数据..."></textarea>
<br>
<button id="decode">解析 Base64 → JSON</button>
<span id="status"></span>

<h3>输出结果：</h3>
<pre id="out"></pre>

<script>
const $ = s => document.querySelector(s);
const ok = msg => {$("#status").textContent="✅ "+msg;$("#status").className="ok";}
const err = msg => {$("#status").textContent="❌ "+msg;$("#status").className="err";}

function b64ToBytes(b64){
  b64 = b64.replace(/[\s\r\n]+/g,"").replace(/-/g,"+").replace(/_/g,"/");
  while(b64.length % 4) b64 += "=";
  const bin = atob(b64);
  const u = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) u[i] = bin.charCodeAt(i);
  return u;
}

class Reader {
  constructor(buf){this.buf=buf;this.pos=0;}
  eof(){return this.pos>=this.buf.length;}
  uint32(){let val=0,shift=0,b;do{b=this.buf[this.pos++];val|=(b&0x7f)<<shift;shift+=7;}while(b>=128);return val>>>0;}
  int32(){return this.uint32()|0;}
  int64(){return this.uint32();}
  string(){const len=this.uint32();const s=this.buf.subarray(this.pos,this.pos+len);this.pos+=len;return new TextDecoder().decode(s);}
  double(){const v=new DataView(this.buf.buffer,this.pos,8).getFloat64(0,true);this.pos+=8;return v;}
  skipType(wt){switch(wt){case 0:this.uint32();break;case 1:this.pos+=8;break;case 2:this.pos+=this.uint32();break;case 5:this.pos+=4;break;default:throw Error("Unknown wireType:"+wt);}}
}

function parseMsg(r){
  const obj={};
  while(!r.eof()){
    const tag = r.uint32();
    const id = tag >>> 3, wt = tag & 7;
    if (!id) { r.skipType(wt); continue; }
    let val;
    switch (wt) {
      case 0: val = r.int32(); break;
      case 1: val = r.double(); break;
      case 2: {
        const len = r.uint32();
        const sub = new Reader(r.buf.subarray(r.pos, r.pos + len)); r.pos += len;
        try {
          const inner = parseMsg(sub);
          val = Object.keys(inner).length ? inner : new TextDecoder().decode(sub.buf);
        } catch {
          val = new TextDecoder().decode(sub.buf);
        }
        break;
      }
      case 5: val = r.int32(); break;
      default: r.skipType(wt); continue;
    }
    if (obj[id] === undefined) obj[id] = val;
    else if (Array.isArray(obj[id])) obj[id].push(val);
    else obj[id] = [obj[id], val];
  }
  return obj;
}

const asString = v => (v == null || typeof v === "object") ? "" : String(v);
const asArray = v => Array.isArray(v) ? v : (v !== undefined ? [v] : []);
const fixGameNo = raw => {
  const s = typeof raw === "object" && raw !== null ? Object.values(raw).join("") : asString(raw);
  return s && s.length < 13 ? "25" + s : s;
};

function detectVersion(raw){
  const maxField = Math.max(...Object.keys(raw).map(Number));
  if(maxField>=19)return"v3 (anchor)";
  if(maxField===18)return"v2 (room)";
  if(maxField>=17)return"v1 (standard)";
  if(maxField<=14)return"vLite (basic)";
  return"unknown";
}

function mapPublicBean(raw){
  const ver = detectVersion(raw);
  const parsed = {
    _version: ver,
    cmd: raw[1]??0,
    token: asString(raw[2]),
    codeId: raw[3]??0,
    lobbyId: raw[4]??0,
    gameNo: fixGameNo(raw[5]),
    tableId: raw[6]??0,
    seat: raw[7]??0,
    mid: asString(raw[8]??"0"),
    dList: asArray(raw[9]),
    type: raw[10]??0,
    userName: asString(raw[11]),
    list: asArray(raw[13]),
    object: asString(raw[14]),
    lobbyPush: asArray(raw[15]),
    table: asArray(raw[17]),
    virtual: asArray(raw[16]),
    mids: asArray(raw[18])
  };
  if (parsed.object) {
    try {
      parsed.parsedObject = JSON.parse(parsed.object);
    } catch {}
  }
  return parsed;
}

$("#decode").onclick = () => {
  $("#out").textContent = "";
  const b64 = $("#b64").value.trim();
  if (!b64) { err("请输入 Base64 数据"); return; }
  try {
    const buf = b64ToBytes(b64);
    const raw = parseMsg(new Reader(buf));
    const obj = mapPublicBean(raw);
    $("#out").textContent = JSON.stringify(obj, null, 2);
    ok("解析成功 ✓ 协议版本: " + obj._version);
  } catch (e) {
    err("解析失败: " + e.message);
  }
};
</script>
</body>
</html>
