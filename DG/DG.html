<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <title>DG==WS</title>
  <style>
    body {
      background: #0d1117;
      color: #e6edf3;
      font-family: Consolas, monospace;
      padding: 20px;
    }

    input,
    button {
      margin: 4px 4px 4px 0;
      padding: 4px;
      border-radius: 4px;
      border: none;
    }

    textarea {
      width: 100%;
      height: 1000px;
      background: #161b22;
      color: #c9d1d9;
    }

    button {
      background: #238636;
      color: white;
      cursor: pointer;
    }

    #log {
      white-space: pre-wrap;
      background: #161b22;
      padding: 10px;
      border-radius: 6px;
      height: 1000px;
      overflow: auto;
    }

    .row {
      margin-bottom: 8px;
    }

    .muted {
      font-size: 12px;
      color: #8b949e;
    }

    code {
      background: #161b22;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .header {
      grid-area: header;
      background: #2b3544;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .game-tag {
      padding: 2px 6px;
      border-radius: 4px;
      background: #9b59b6;
      font-size: 11px;
    }

    .table-name {
      font-weight: 600;
      font-size: 14px;
    }

    .header-right {
      display: flex;
      gap: 12px;
      font-size: 12px;
      opacity: 0.9;
    }

    .header-right span strong {
      color: #ffd166;
      margin-right: 2px;
    }

    .road {
      grid-area: road;
      padding: 8px;
      background: #11161f;
    }

    .road-title {
      font-size: 12px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #9ca3af;
    }

    .road-stats {
      font-size: 11px;
      display: flex;
      gap: 8px;
    }

    .road-stats span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .dot-b,
    .dot-p,
    .dot-t {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot-b {
      background: #e74c3c;
    }

    .dot-p {
      background: #3498db;
    }

    .dot-t {
      background: #2ecc71;
    }

    .road-grid {
      margin-top: 4px;
      background: #05070b;
      border-radius: 4px;
      padding: 4px;
      display: grid;
      gap: 2px;
    }

    .road-cell {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      box-sizing: border-box;
    }

    .road-cell.empty {
      border: 1px solid rgba(55, 65, 81, 0.5);
      background: transparent;
    }

    .road-cell.b {
      background: #e74c3c;
      border-color: #c0392b;
    }

    .road-cell.p {
      background: #3498db;
      border-color: #2980b9;
    }

    .road-cell.t {
      background: #2ecc71;
      border-color: #27ae60;
    }

    .road-cell.pair::after {
      content: "â€¢";
      font-size: 12px;
      color: #f1c40f;
    }

    .dealer {
      grid-area: dealer;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      background: #0f1722;
      border-left: 1px solid #374151;
    }

    .dealer-img-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 4px;
    }

    .dealer-img {
      width: 96px;
      height: 126px;
      border-radius: 6px;
      object-fit: cover;
      background: #111827;
      border: 1px solid #4b5563;
    }

    .dealer-name {
      font-size: 12px;
      margin-bottom: 4px;
      text-align: center;
    }

    .status-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #1e3a8a;
      color: #bfdbfe;
    }

    .status-pill--shuffle {
      background: #92400e;
      color: #fed7aa;
    }

    .status-pill--maintenance {
      background: #7f1d1d;
      color: #fecaca;
    }

    .footer {
      grid-area: footer;
      background: #11161f;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      border-top: 1px solid #1f2933;
    }

    .footer-left {
      display: flex;
      gap: 12px;
    }

    .footer-left span strong {
      margin-right: 4px;
      color: #fbbf24;
    }

    .enter-btn {
      padding: 4px 12px;
      border-radius: 16px;
      border: none;
      background: #22c55e;
      color: #052e16;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .enter-btn:hover {
      background: #16a34a;
    }

    .debug {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      white-space: pre-wrap;
      background: #020617;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
    }

    /* æ¡Œå°å®¹å™¨ï¼šä½¿ç”¨ flex å¸ƒå±€ */
    #dg-table-container {
      display: flex;
      flex-wrap: wrap;
      /* å¤šè¡Œæ’åˆ— */
      gap: 16px;
      /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
      align-items: flex-start;
    }

    .table-card {
      width: 520px;
      background: #1b222c;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      display: grid;
      grid-template-columns: 3fr 1.2fr;
      grid-template-rows: auto auto 1fr;
      grid-template-areas:
        "header header"
        "road dealer"
        "footer footer";
      margin-top: 10px;
    }

    .table-card {
      /* flex å­é¡¹çš„å®½åº¦ï¼ˆ3 åˆ—å¸ƒå±€ï¼Œç•™ä¸€ç‚¹é—´éš”ï¼‰*/
      flex: 0 0 calc(33.333% - 16px);
      max-width: 520px;
      /* ä¸è¶…è¿‡åŸæ¥å¤§å° */
      min-width: 320px;
      /* å¤ªçª„å°±è‡ªåŠ¨æ¢è¡Œ */

      background: #1b222c;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      display: grid;
      grid-template-columns: 3fr 1.2fr;
      grid-template-rows: auto auto 1fr;
      grid-template-areas:
        "header header"
        "road dealer"
        "footer footer";
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <section>
    <h3>â‘  ç™»å½•</h3>
    <div class="row">
      <label>ç”¨æˆ·å</label>
      <input id="username" value="member19" />
      <label>å¯†ç </label>
      <input id="password" type="password" value="a123456" />
      <button id="btnLogin">ç™»å½•</button>
    </div>
    <div class="muted">
      ä¿å­˜åˆ° localStorage é”®ï¼š<code>nakiph_auth</code>
    </div>
    <pre id="loginOut">ï¼ˆç­‰å¾…ï¼‰</pre>
  </section>

  <section>
    <h3>â‘¡ è¿›å…¥æ¸¸æˆï¼ˆä½¿ç”¨å·²ä¿å­˜çš„ Authorizationï¼‰</h3>
    <div class="row">
      <label>code</label><input id="eg_code" value="1" />
      <label>gamerCode</label><input id="eg_gamer" value="DG" />
      <label>providerCode</label><input id="eg_provider" value="cq9" />
      <label>live</label><input id="eg_live" value="true" />
      <label>html</label><input id="eg_html" value="true" />
      <button id="btnEnter" disabled>è¿›å…¥æ¸¸æˆ</button>
    </div>
    <pre id="enterOut">ï¼ˆç­‰å¾…ï¼‰</pre>
  </section>

  <section>
    <h3>â‘¢ è·å– wskeyï¼ˆè§£æ bundle.js ä¸­çš„ t.wskeyï¼‰</h3>
    <div class="row">
      <label>bundle.js</label>
      <input id="bundleUrl" class="grow" value="https://new-dd-cn.20299999.com/ddnewpc/V3.1.7/js/bundle.js" />
      <button id="btnWsKey">è·å– wskey</button>
    </div>
    <div class="muted">
      ä¿å­˜åˆ° localStorage é”®ï¼š<code>nakiph_wskey</code>
    </div>
    <pre id="wskeyOut">ï¼ˆç­‰å¾…ï¼‰</pre>
  </section>

  <section>
    <h2>WS</h2>
    <label>Token: <input id="token" size="60" /></label><br />
    <label>WSKEY:
      <input id="wskey" value="pV5mY8dR2qGxH1sK9tBzN6uC3fWjE0aL7rTnJ4cQvSgPZyFMiXoUbDlAhOeRwd36"
        size="75" /></label><br />
    <label>mid: <input id="mid" value="99" size="20" /></label>
    <label>tableId: <input id="tableId" value="1" size="5" /></label>
    <label>type: <input id="type" value="0" size="5" /></label><br />
    <button onclick="connectWS()">è¿æ¥</button>
    <button onclick="closingWS()">å…³é—­è¿æ¥</button>
    <button onclick="sendPacket(99)">å‘é€å¿ƒè·³</button>
    <button onclick="sendPacket(10086)">å‘é€ 10086</button>
    <div id="status"></div>

    <h3>æ—¥å¿—è¾“å‡º</h3>
    <button onclick="ClearLogs()">æ¸…é™¤æ—¥å¿—</button>
    <!-- <div id="log"></div> -->
  </section>

  <!-- æ–°å¢ï¼šæ¡Œå°å±•ç¤ºåŒºï¼ˆçœŸå®æ•°æ®æ¥äº†ä¹‹åå°±æ›´æ–°è¿™é‡Œï¼‰ -->
  <section>
    <h3>æ¡Œå°å±•ç¤ºï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰</h3>
    <p class="muted">
      åœ¨ä»»æ„åœ°æ–¹æ‹¿åˆ°ç±»ä¼¼ä½ å‘çš„ç»“æ„æ•°æ®åï¼Œè°ƒç”¨ï¼š
      <code>updateDgTableCard(yourData)</code>
      å³å¯æ›´æ–°ä¸‹æ–¹å¡ç‰‡ã€‚
    </p>
    <div id="dg-table-container"></div>
    <div id="dg-table-debug" class="debug"></div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>
  <script>
    /** ====== å…¬å…±å­˜å– ====== */
    const BASE = "https://phpclienta.nakiph.xyz";
    const LS_AUTH = "nakiph_auth";
    const LS_WSKEY = "nakiph_wskey";
    const LS_GAME_TOKEN = "nakiph_gameToken";

    const $ = (id) => document.getElementById(id);
    const outLogin = $("loginOut");
    const outEnter = $("enterOut");
    const outWskey = $("wskeyOut");
    const outSendPreview = $("sendPreview");

    function saveAuthFromLogin(loginData) {
      const rs = loginData?.resultSet || {};
      const auth = {
        tokenHeader: rs.tokenHeader || "Authorization",
        tokenPrefix: rs.tokenPrefix || "Bearer_",
        accessToken: rs.accessToken || "",
      };
      if (!auth.accessToken) throw new Error("æœªè·å–åˆ° accessToken");
      localStorage.setItem(LS_AUTH, JSON.stringify(auth));
      return auth;
    }
    function getSavedAuth() {
      try {
        const raw = localStorage.getItem(LS_AUTH);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }
    function buildAuthHeaders(auth) {
      const h = {};
      h[auth.tokenHeader] = auth.tokenPrefix + auth.accessToken;
      return h;
    }

    /** ====== â‘  ç™»å½• ====== */
    $("btnLogin").onclick = async () => {
      outLogin.textContent = "ç™»å½•ä¸­â€¦";
      try {
        const userName = $("username").value.trim();
        const password = $("password").value;
        const res = await fetch(`${BASE}/member/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userName, password }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok)
          throw new Error(
            `HTTP ${res.status} ${res.statusText} - ${JSON.stringify(data)}`
          );
        outLogin.textContent = JSON.stringify(data, null, 2);
        const auth = saveAuthFromLogin(data);
        $("btnEnter").disabled = false;

        // å°†ç™»å½• token å¡«å…¥åŸå§‹ i é‡Œï¼ˆä¾¿äºç›´æ¥åŠ å¯†å‘é€ï¼‰
        try {
          const obj = JSON.parse($("rawI").value);
          if (!obj.token || obj.token.includes("é»˜è®¤è‡ªåŠ¨å¡«å……")) {
            obj.token = auth.accessToken;
            $("rawI").value = JSON.stringify(obj, null, 2);
          }
        } catch { }
      } catch (e) {
        outLogin.textContent = "âŒ " + (e.message || e);
      }
    };

    /** ====== â‘¡ è¿›å…¥æ¸¸æˆ ====== */
    $("btnEnter").onclick = async () => {
      outEnter.textContent = "è¿›å…¥æ¸¸æˆä¸­â€¦";
      try {
        const auth = getSavedAuth();
        if (!auth?.accessToken)
          throw new Error("æœ¬åœ°æ²¡æœ‰ accessTokenï¼Œè¯·å…ˆç™»å½•");
        const body = {
          code: $("eg_code").value,
          gamerCode: $("eg_gamer").value,
          providerCode: $("eg_provider").value,
          live: $("eg_live").value === "true",
          isCockfighting: false,
          html: $("eg_html").value === "true",
        };
        const res = await fetch(`${BASE}/game/enterGame`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...buildAuthHeaders(auth),
          },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok)
          throw new Error(
            `HTTP ${res.status} ${res.statusText} - ${JSON.stringify(data)}`
          );
        outEnter.textContent = JSON.stringify(data, null, 2);

        // ================= è§£ææ¸¸æˆ tokenï¼ˆURL å‚æ•°é‡Œçš„ tokenï¼‰ =================
        const url = data?.resultSet;
        if (url && typeof url === "string") {
          const u = new URL(url);
          const gameToken = u.searchParams.get("token");
          if (gameToken) {
            localStorage.setItem(LS_GAME_TOKEN, gameToken);

            // âœ… æ›´æ–°åŸå§‹å‚æ•° i å†…çš„ tokenï¼Œåç»­å‘é€ WS ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ä¸ª token
            try {
              const obj = JSON.parse($("rawI").value);
              obj.token = gameToken;
              $("rawI").value = JSON.stringify(obj, null, 2);
            } catch { }

            // âœ… è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
            $("token").value = gameToken;

            // æ—¥å¿—ç¡®è®¤
            outEnter.textContent += `\n\nâœ… å·²è§£ææ¸¸æˆ token:\n${gameToken}`;
          } else {
            outEnter.textContent += `\n\nâš  æœªæ‰¾åˆ° token å‚æ•°`;
          }
        }
      } catch (e) {
        outEnter.textContent = "âŒ " + (e.message || e);
      }
    };

    /** ====== â‘¢ è·å– wskey ====== */
    $("btnWsKey").onclick = async () => {
      outWskey.textContent = "è¯·æ±‚ bundle.js ä¸­â€¦";
      try {
        const url = $("bundleUrl").value.trim();
        const res = await fetch(url);
        const text = await res.text();
        const m = text.match(/t\.wskey\s*=\s*"([^"]+)"/);
        if (!m) throw new Error("æœªåŒ¹é…åˆ° t.wskey");
        const wskey = m[1].split("").reverse().join("");
        localStorage.setItem(LS_WSKEY, wskey);
        outWskey.textContent = `âœ… wskey å·²ä¿å­˜ï¼š\n\n${wskey}`;
      } catch (e) {
        outWskey.textContent = "âŒ " + (e.message || e);
      }
    };
    // åˆå§‹æ˜¾ç¤ºå·²æœ‰ wskey
    (function () {
      const exist = localStorage.getItem(LS_WSKEY);
      if (exist) outWskey.textContent = `âœ… å·²ä¿å­˜çš„ wskeyï¼š\n\n${exist}`;
    })();

    /* ======================== å®½å®¹è§£ç ï¼ˆä¸ä¾èµ– .protoï¼‰ ======================== */
    class Reader {
      constructor(buf) {
        this.buf = buf;
        this.pos = 0;
      }
      eof() {
        return this.pos >= this.buf.length;
      }
      uint32() {
        let val = 0,
          shift = 0,
          b;
        do {
          b = this.buf[this.pos++];
          val |= (b & 0x7f) << shift;
          shift += 7;
        } while (b >= 128);
        return val >>> 0;
      }
      int32() {
        return this.uint32() | 0;
      }
      int64() {
        return this.uint32();
      }
      string() {
        const len = this.uint32();
        const s = this.buf.subarray(this.pos, this.pos + len);
        this.pos += len;
        return new TextDecoder().decode(s);
      }
      double() {
        const v = new DataView(
          this.buf.buffer,
          this.buf.byteOffset + this.pos,
          8
        ).getFloat64(0, true);
        this.pos += 8;
        return v;
      }
      skipType(wt) {
        switch (wt) {
          case 0:
            this.uint32();
            break;
          case 1:
            this.pos += 8;
            break;
          case 2: {
            const l = this.uint32();
            this.pos += l;
            break;
          }
          case 5:
            this.pos += 4;
            break;
          default:
            throw Error("Unknown wireType: " + wt);
        }
      }
    }

    function parseMsg(r) {
      const obj = {};
      while (!r.eof()) {
        const tag = r.uint32();
        const id = tag >>> 3,
          wt = tag & 7;
        if (!id) {
          r.skipType(wt);
          continue;
        }
        let val;
        switch (wt) {
          case 0:
            val = r.int32();
            break;
          case 1:
            val = r.double();
            break;
          case 2: {
            const len = r.uint32();
            const sub = new Reader(r.buf.subarray(r.pos, r.pos + len));
            r.pos += len;
            try {
              const inner = parseMsg(sub);
              val = Object.keys(inner).length
                ? inner
                : new TextDecoder().decode(sub.buf);
            } catch {
              val = new TextDecoder().decode(sub.buf);
            }
            break;
          }
          case 5:
            val = r.int32();
            break;
          default:
            r.skipType(wt);
            continue;
        }
        if (obj[id] === undefined) obj[id] = val;
        else if (Array.isArray(obj[id])) obj[id].push(val);
        else obj[id] = [obj[id], val];
      }
      return obj;
    }

    // å·¥å…·
    const asString = (v) => {
      if (v == null) return "";
      if (typeof v === "string") return v;
      if (typeof v === "object") return "";
      return String(v);
    };

    // æ˜ å°„ Virtual
    function mapVirtual(r) {
      if (!r) return [];
      const arr = Array.isArray(r) ? r : [r];
      return arr.map((v) => ({
        seatId: v[1] ?? 0,
        userName: asString(v[2]),
        currency: asString(v[3]),
        betInfo: asString(v[4]),
        balance: v[5] ?? 0,
        type: v[6] ?? 0,
        mid: asString(v[7]),
        streak: v[8] ?? 0,
        betNum: v[9] ?? 0,
        winNum: v[10] ?? 0,
        head: asString(v[11]),
        deviceType: v[12] ?? 0,
        list: Array.isArray(v[13]) ? v[13].map(asString) : [],
      }));
    }

    // æ˜ å°„ Dealer
    function mapDealer(r) {
      if (!r) return null;
      return {
        id: r[1] ?? 0,
        name: asString(r[2]),
        no: asString(r[3]),
        photo: asString(r[4]),
        gender: r[5] ?? 0,
        online: !!r[6],
        type: r[9] ?? 0,
      };
    }

    // æ˜ å°„ LobbyPush
    function mapLobbyPush(r) {
      if (!r) return [];
      const arr = Array.isArray(r) ? r : [r];
      return arr.map((v) => ({
        tableId: v[1] ?? 0,
        onlineCount: +(v[2] ?? 0),
        totalAmount: +(v[3] ?? 0),
        vipName: asString(v[4]),
        seatFull: !!v[5],
      }));
    }

    function fixGameNo(raw) {
      if (typeof raw === "object" && raw !== null) {
        const s = Object.values(raw).join("");
        return s && s.length < 13 ? "25" + s : s;
      }
      const s = asString(raw);
      return s && s.length < 13 ? "25" + s : s;
    }

    // æ˜ å°„ Table
    function mapTable(r) {
      if (!r) return [];
      const arr = Array.isArray(r) ? r : [r];
      return arr.map((v) => ({
        tableId: v[1] ?? 0,
        shoeId: asString(v[2]),
        playId: asString(v[3]),
        state: v[4] ?? 0,
        countDown: v[5] ?? 0,
        result: asString(v[6]),
        poker: asString(v[7]),
        tel: Array.isArray(v[8]) ? v[8].map(asString) : [],
        ext: Array.isArray(v[9]) ? v[9].map(asString) : [],
        roads: Array.isArray(v[10]) ? v[10].map(asString) : [],
        gameNo: fixGameNo(v[11]),
        fms: asString(v[12]),
        tableName: asString(v[13]),
        vipName: asString(v[14]),
        totalAmount: v[15] ?? 0,
        onlineCount: v[16] ?? 0,
        dealer: mapDealer(v[17]),
        gameId: v[18] ?? 0,
        anchor: v[19] ?? null,
      }));
    }

    function detectVersion(raw) {
      const keys = Object.keys(raw)
        .map(Number)
        .filter((n) => !isNaN(n));
      const maxField = keys.length ? Math.max(...keys) : 0;
      if (maxField >= 19) return "v3 (anchor)";
      if (maxField === 18) return "v2 (room)";
      if (maxField >= 17) return "v1 (standard)";
      if (maxField <= 14) return "vLite (basic)";
      return "unknown";
    }

    function mapPublicBean(raw) {
      const ver = detectVersion(raw);
      const o = {
        _version: ver,
        cmd: raw[1] ?? 0,
        token: asString(raw[2]),
        codeId: raw[3] ?? 0,
        lobbyId: raw[4] ?? 0,
        gameNo: asString(raw[5]),
        tableId: raw[6] ?? 0,
        seat: raw[7] ?? 0,
        mid: asString(raw[8] ?? "0"),
        dList: Array.isArray(raw[9]) ? raw[9] : [],
        type: raw[10] ?? 0,
        userName: asString(raw[11]),
        list: Array.isArray(raw[12]) ? raw[12].map(asString) : [],
        mids: Array.isArray(raw[13]) ? raw[13] : [],
        object: asString(raw[14]),
        virtual: mapVirtual(raw[15]),
        lobbyPush: mapLobbyPush(raw[16]),
        table: mapTable(raw[17]),
      };
      if (raw[18]) o.room = raw[18];
      if (raw[19]) o.anchor = raw[19];
      return o;
    }

    function sendPublic(ws, base) {
      const buf = buildPacket(base);
      ws.send(buf);
      appendLog(`[SEND] ${JSON.stringify(base)}`);
      console.log(`[SEND] cmd=${base.cmd} bytes=${buf.length}`);
    }

    /* ======================== ws ======================== */
    let ws = null;
    let PublicBean = new protobuf.Type("PublicBean")
      .add(new protobuf.Field("cmd", 1, "int32"))
      .add(new protobuf.Field("token", 2, "string"))
      .add(new protobuf.Field("codeId", 3, "int32"))
      .add(new protobuf.Field("lobbyId", 4, "int32"))
      .add(new protobuf.Field("gameNo", 5, "string"))
      .add(new protobuf.Field("tableId", 6, "int32"))
      .add(new protobuf.Field("seat", 7, "int32"))
      .add(new protobuf.Field("mid", 8, "int64"))
      .add(new protobuf.Field("dList", 9, "double", "repeated"))
      .add(new protobuf.Field("type", 10, "int32"))
      .add(new protobuf.Field("userName", 11, "string"))
      .add(new protobuf.Field("list", 12, "string", "repeated"))
      .add(new protobuf.Field("mids", 13, "int64", "repeated"))
      .add(new protobuf.Field("object", 14, "string"));

    function log(msg) {
      // const l = document.getElementById("log");
      // l.textContent += msg + "\n";
      // l.scrollTop = l.scrollHeight;
    }

    function ClearLogs() {
      // const l = document.getElementById("log");
      // l.textContent = "";
    }

    function status(msg) {
      document.getElementById("status").textContent = msg;
    }

    function getEncryptToken(str) {
      const wskey = document.getElementById("wskey").value.trim();
      const key = CryptoJS.enc.Utf8.parse(wskey);
      const enc = CryptoJS.TripleDES.encrypt(str, key, {
        mode: CryptoJS.mode.ECB,
        padding: CryptoJS.pad.Pkcs7,
      });
      return enc.toString();
    }

    function buildPacket(cmd, extra = {}) {
      const token = document.getElementById("token").value.trim();
      const mid = document.getElementById("mid").value.trim();
      const tableId = parseInt(
        document.getElementById("tableId").value.trim()
      );
      const type = parseInt(document.getElementById("type").value.trim());
      const envelope = {
        cmd,
        token,
        time: Date.now(),
      };
      const encToken = getEncryptToken(JSON.stringify(envelope));

      const payload = {
        cmd,
        token: encToken,
        codeId: 0,
        lobbyId: 0,
        gameNo: "",
        seat: 0,
        tableId,
        mid,
        dList: [],
        type,
        userName: "",
        list: [],
        mids: [],
        object: cmd === 10086 ? "PC" : "",
        ...extra,
      };
      return PublicBean.encode(payload).finish();
    }

    function handleTableArrayLike(mapped, targetMap, fieldName) {
      if (Array.isArray(mapped[fieldName])) {
        for (const t of mapped[fieldName]) {
          const tid = Number(t.tableId || t.tableID);
          if (!tid) continue;
          targetMap[tid] = t;
        }
        schedulePush();
      }
    }

    function connectWS() {
      const token = document.getElementById("token").value.trim();
      const sign = getEncryptToken(token);
      const url = `wss://hwdata-new.taxyss.com/?sign=${sign}`;
      log("è¿æ¥åˆ°: " + url);
      ws = new WebSocket(url);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        log("âœ… å·²è¿æ¥");
        status("å·²è¿æ¥");
        // sendPacket(99);
        setInterval(() => sendPacket(99), 2000);
        setTimeout(() => sendInitSeq(), 1000);
      };
      ws.onclose = (e) => {
        log("ğŸ”Œ è¿æ¥å…³é—­ code=" + e.code + " reason=" + e.reason);
        status("è¿æ¥å…³é—­");
      };
      ws.onerror = (err) => {
        log("âŒ è¿æ¥é”™è¯¯");
        status("è¿æ¥é”™è¯¯");
      };
      ws.onmessage = (e) => {
        try {
          const raw = parseMsg(new Reader(new Uint8Array(e.data)));
          const mapped = mapPublicBean(raw);
          const cmd = mapped.cmd | 0;

          // è°ƒè¯•ï¼šå…³é”®åŒ…æ‰“å°åœ¨æ§åˆ¶å°
          if (
            cmd === 43 ||
            cmd === 10086 ||
            cmd === 1002 ||
            cmd === 1004 ||
            cmd === 201 ||
            cmd === 208 ||
            cmd === 5014 ||
            cmd === 5015 ||
            cmd === 6 ||
            cmd === 24 ||
            cmd === 1003
          ) {
            console.log("ğŸš€ [WS] cmd=", cmd, mapped);
          }

          log("ğŸ“© æ”¶åˆ°: " + JSON.stringify(mapped));

          // === æ ¹æ®ä¸åŒ cmd æ›´æ–° pushState å¿«ç…§ ===
          if (mapped && typeof mapped === "object") {
            const tableId = mapped.tableId || mapped.tableID || 0;

            switch (cmd) {
              case 10086:
                // å¤§å…ä¿¡æ¯ï¼ˆç™»å½•ä¿¡æ¯ / token / key / username ç­‰ï¼‰
                pushState.list = Array.isArray(mapped.list) ? mapped.list : [];
                // è¿™é‡Œå¦‚æœä½ æƒ³é¡ºä¾¿è§£æ 10086 çš„ key / tokenï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œåš
                schedulePush();
                break;

              case 43:
                // å¤§å…æ¡Œå°æ€»è§ˆ
                pushState.table = Array.isArray(mapped.table) ? mapped.table : [];
                console.log(
                  "ğŸ² 43 æ¡Œå°åˆ—è¡¨ tableIds =",
                  pushState.table.map(t => t.tableId || t.tableID)
                );
                schedulePush();
                break;

              case 1002:
                // å•æ¡Œå®æ—¶çŠ¶æ€
                handleTableArrayLike(mapped, pushState.tableStateById, "table");
                break;

              case 1004:
                // è·¯çº¸ï¼šlist æ˜¯ç±»ä¼¼ "#X#Y#Z" çš„æ•°ç»„
                handleTableArrayLike(mapped, pushState.roadsByTableId, "table");
                break;

              case 201:
                // æ¡Œä¸Šç©å®¶ä¿¡æ¯
                handleTableArrayLike(mapped, pushState.playersByTableId, "table");

                break;

              case 208:
                // å½“å‰æ¡Œå°æ€»æŠ•æ³¨é¢ç»Ÿè®¡
                handleTableArrayLike(mapped, pushState.betAreaByTableId, "table");
                break;

              case 5014:
                // æ¸¸æˆç»Ÿè®¡ / èƒœç‡åˆ†æ
                handleTableArrayLike(mapped, pushState.statsByTableId, "table");
                break;

              case 85:
                // èŠå¤©ï¼šè¿™é‡Œç®€å•è®°å½•â€œå½“å‰æ¡Œå°æœ€è¿‘ä¸€æ¡â€
                if (tableId) {
                  pushState.chatByTableId[tableId] = mapped;
                  schedulePush();
                }
                break;

              case 5015:
                // æ¸¸æˆäº‹ä»¶ï¼ˆè¿›å…¥ç‰Œå±€ã€ç¦»å¼€æˆ¿é—´ç­‰ï¼‰
                if (tableId) {
                  pushState.eventsByTableId[tableId] = mapped;
                  schedulePush();
                }
                break;

              case 6:
                // ä¸‹æ³¨æˆåŠŸä¿¡æ¯ï¼šdList[0] æ˜¯ä½™é¢
                if (tableId) {
                  pushState.betResultByTableId[tableId] = mapped;
                  schedulePush();
                }
                break;

              case 24:
                // å¯Œè±ªæ¦œï¼šç›´æ¥è¦†ç›–
                pushState.richList = Array.isArray(mapped.list)
                  ? mapped.list
                  : [];
                schedulePush();
                break;

              case 1003:
                // å¼€ç‰Œç»“æœï¼štableId + gameNo ä½œä¸º key
                if (tableId && mapped.gameNo) {
                  if (!pushState.openCardByTableId[tableId]) {
                    pushState.openCardByTableId[tableId] = {};
                  }
                  pushState.openCardByTableId[tableId][mapped.gameNo] = mapped;
                  schedulePush();
                }
                break;

              default:
                // å…¶å®ƒ cmd ä¸å‚ä¸æ¨é€èšåˆ
                break;
            }
          }
        } catch (err) {
          log("ğŸ“© è§£ç å¤±è´¥: " + err.message);
        }
      };
    }

    function closingWS() {
      ws.close();
    }

    function sendPacket(cmd) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return alert("æœªè¿æ¥");
      const buf = buildPacket(cmd);
      console.log(buf);
      ws.send(buf);
      log("ğŸ“¤ å·²å‘é€ cmd=" + cmd);
    }

    function sendInitSeq() {
      const seq = [
        {
          cmd: 10086,
          tableId: 1,
          type: 0,
          object: "PC",
        },
        {
          cmd: 45,
          type: 1,
        },
        {
          cmd: 43,
          tableId: 1,
          type: 0,
        },
        {
          cmd: 5011,
          type: 0,
        },
        {
          cmd: 87,
          type: 1,
        },
        {
          cmd: 24,
          type: 2,
        },
      ];
      log("ğŸš€ åˆå§‹åŒ–åºåˆ—å¼€å§‹...");
      (async () => {
        for (const pkt of seq) {
          const buf = buildPacket(pkt.cmd, pkt);
          ws.send(buf);
          log("ğŸ“¤ å·²å‘é€ cmd=" + pkt.cmd);
          await new Promise((r) => setTimeout(r, 300));
        }
        log("âœ… åˆå§‹åŒ–å®Œæˆ");
      })();
    }

    /* ======================== æ¨é€ WSï¼ˆå‘ phpclientd å‘é€èšåˆæ•°æ®ï¼‰ ======================== */
    let wsPush = null;
    let pushQueue = [];
    // æ‰€æœ‰ cmd çš„æœ€æ–°å¿«ç…§éƒ½æ”¾è¿™é‡Œ
    const pushState = {
      // 10086 å¤§å…ä¿¡æ¯ï¼ˆåŸæ¥å°±æœ‰ï¼‰
      list: [],

      // 43 å¤§å…æ¡Œå°æ€»è§ˆï¼ˆåŸæ¥å°±æœ‰ï¼‰
      table: [],

      // 1002 å•æ¡Œå®æ—¶çŠ¶æ€ï¼šæŒ‰ tableId å­˜
      tableStateById: {},

      // 1004 è·¯çº¸ï¼šæŒ‰ tableId å­˜
      roadsByTableId: {},

      // 201 æ¡Œä¸Šç©å®¶ï¼šæŒ‰ tableId å­˜
      playersByTableId: {},

      // 208 å½“å‰æ¡Œå°æ€»æŠ•æ³¨é¢ç»Ÿè®¡ï¼šæŒ‰ tableId å­˜
      betAreaByTableId: {},

      // 5014 æ¸¸æˆç»Ÿè®¡/èƒœç‡åˆ†æï¼šæŒ‰ tableId å­˜
      statsByTableId: {},

      // 85 èŠå¤©ï¼šæŒ‰ tableId å­˜ä¸€ä»½æœ€è¿‘å¿«ç…§ï¼ˆä½ è¦å­˜æ•°ç»„ä¹Ÿå¯ä»¥ï¼‰
      chatByTableId: {},

      // 5015 æ¸¸æˆäº‹ä»¶ï¼šæŒ‰ tableId å­˜æœ€è¿‘ä¸€æ¬¡
      eventsByTableId: {},

      // 6 ä¸‹æ³¨æˆåŠŸä¿¡æ¯ï¼šæŒ‰ tableId å­˜æœ€è¿‘ä¸€æ¬¡
      betResultByTableId: {},

      // 24 å¯Œè±ªæ¦œï¼šç›´æ¥å­˜æ•°ç»„
      richList: [],

      // 1003 å¼€ç‰Œç»“æœï¼šæŒ‰ tableId + gameNo å­˜
      openCardByTableId: {},
    };
    let pushTimer = null;


    function connectPushWS() {
      const url = "wss://phpclienta.nakiph.xyz/ws/getTableInfos";
      log("æ¨é€WS è¿æ¥åˆ°: " + url);
      wsPush = new WebSocket(url);
      wsPush.onopen = () => {
        log("âœ… æ¨é€WS å·²è¿æ¥");
        // å‘é€é˜Ÿåˆ—ä¸­ç§¯å‹çš„æ¶ˆæ¯
        if (pushQueue.length) {
          pushQueue.forEach((msg) => wsPush.send(msg));
          pushQueue = [];
        }
      };
      wsPush.onclose = (e) => {
        log("ğŸ”Œ æ¨é€WS è¿æ¥å…³é—­ code=" + e.code + " reason=" + e.reason);
        // ç®€å•é‡è¿ç­–ç•¥ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰
        setTimeout(connectPushWS, 2000);
      };
      wsPush.onerror = () => {
        log("âŒ æ¨é€WS è¿æ¥é”™è¯¯");
      };
    }

    function ensurePushWS() {
      if (!wsPush || wsPush.readyState === WebSocket.CLOSED) {
        connectPushWS();
        return false;
      }
      return wsPush.readyState === WebSocket.OPEN;
    }
    // åˆå¹¶å‘é€ï¼šå§‹ç»ˆå‘é€ {list, table} çš„â€œå½“å‰å¿«ç…§â€
    function pushCombined() {
      const payload = {
        type: "dgGameTableInfos",
        data: {
          list: Array.isArray(pushState.list) ? pushState.list : [],
          table: Array.isArray(pushState.table) ? pushState.table : [],
          tableStateById: pushState.tableStateById,
          roadsByTableId: pushState.roadsByTableId,
          playersByTableId: pushState.playersByTableId,
          betAreaByTableId: pushState.betAreaByTableId,
          statsByTableId: pushState.statsByTableId,
          chatByTableId: pushState.chatByTableId,
          eventsByTableId: pushState.eventsByTableId,
          betResultByTableId: pushState.betResultByTableId,
          richList: pushState.richList,
          openCardByTableId: pushState.openCardByTableId,
        },
      };

      // â­ ç”¨çœŸå®æ•°æ®åˆ·æ–°å‰ç«¯ demo â€”â€” å±•ç¤ºæ‰€æœ‰æ¡Œå­
      if (window.updateDgTableCard) {
        const allTables = Array.isArray(pushState.table) ? pushState.table : [];
        const uiList = [];

        // éå† 43 é‡Œçš„æ¯ä¸€ä¸ªæ¡Œå­
        for (const t of allTables) {
          const tid = Number(t.tableId || t.tableID);
          if (!tid) continue;
          const uiData = buildUiTableData(tid);
          if (uiData) uiList.push(uiData);
        }

        console.log("ğŸ¯ å°†è¦æ¸²æŸ“çš„æ¡Œå­æ•°é‡ =", uiList.length);

        if (uiList.length) {
          // æ³¨æ„è¿™é‡Œä¼ çš„æ˜¯æ•°ç»„
          updateDgTableCard(uiList);
        } else {
          console.warn("âš ï¸ æœ‰ 43 æ•°æ®ï¼Œä½†æš‚æ—¶æ²¡æœ‰å¯ç”¨çš„ uiData");
        }
      }

      const text = JSON.stringify(payload);
      if (ensurePushWS()) {
        wsPush.send(text);
      } else {
        pushQueue.push(text);
      }
      log("ğŸ“¤ æ¨é€WS å·²å‘é€åˆå¹¶ dgGameTableInfos");
    }

    // ç”¨ pushState é‡Œæœ€æ–°çš„æ•°æ®æ‹¼å‡ºä¸€å¼ æ¡Œå­çš„å±•ç¤ºç»“æ„
    function buildUiTableData(tableId) {
      tableId = Number(tableId) || 0;
      if (!tableId) return null;

      // 43 è¿”å›çš„å¤§å…æ¡Œå°æ•°ç»„é‡Œæ‰¾å¯¹åº”å°
      const allTables = Array.isArray(pushState.table) ? pushState.table : [];
      const summary = allTables.find(
        t => Number(t.tableId || t.tableID) === tableId
      );
      if (!summary) return null;

      // 1002 å•æ¡ŒçŠ¶æ€
      const state1002 = pushState.tableStateById[tableId] || {};
      // 1004 è·¯çº¸
      const roads1004 = pushState.roadsByTableId[tableId] || {};
      // 208 å½“å‰æ¡Œå°æ€»æŠ•æ³¨é¢
      const bet208 = pushState.betAreaByTableId[tableId] || {};
      // ä½ é‚£ç§å¤§å…ç»“æ„é‡Œçš„ betInfo
      const betInfo = {
        betCount: bet208.betCount || summary.onlineCount || 0,
        currentBet:
          bet208.totalAmount ||
          summary.totalAmount ||
          0,
      };

      // tableInfoï¼šå°½é‡å¯¹é½ä½ å‘çš„ç¤ºä¾‹ç»“æ„
      const tableInfo = {
        stampTime: Date.now(),
        dealerDomain: 1,
        gameHall: 0,
        gameCode: summary.gameId || 0,
        tableID: tableId,
        tableName: summary.tableName || "",
        gameShoe: Number(state1002.shoeId || summary.shoeId || 0),
        gameRound: Number(state1002.playId || summary.playId || 0),
        shuffle: 0,
        maintenance: 0,
        dealerID: summary.dealer
          ? `${summary.dealer.name || ""}/-/${summary.dealer.id || ""}`
          : "",
        dealerImage: summary.dealer ? summary.dealer.photo || "" : "",
        supportWeb: 1,
        newGame: 0,
      };

      // dealerEventï¼šç”¨ 1002 çš„çŠ¶æ€æ‹¼ä¸€ä»½
      const dealerEvent = {
        dealerId: tableInfo.dealerID,
        deliverTime: Date.now(),
        eventType:
          state1002.state === 1
            ? "GP_BETTING"
            : state1002.state === 2
              ? "GP_DEALING"
              : state1002.state === 5
                ? "GP_SETTLEMENT"
                : "GP_NEW_GAME_START",
        tableID: tableId,
        gameRound: tableInfo.gameRound,
        gameShoe: tableInfo.gameShoe,
        iTime: state1002.countDown || 0,
        roundStartTime: Date.now(),
        shuffle: 0,
        timestamp: Date.now(),
      };

      // roadInfoï¼šç›´æ¥å¡ 1004 åŸå§‹æ•°æ® + winCounts å ä½
      const roadInfo = {
        repaintTime: Date.now(),
        tableID: tableId,
        gameShoe: tableInfo.gameShoe,
        gameRound: tableInfo.gameRound,
        winCounts: roads1004.winCounts || [0, 0, 0],
        goodRoadType: roads1004.goodRoadType || 0,
        goodRoadCount: roads1004.goodRoadCount || 0,
        prevGoodRoadJson: roads1004.prevGoodRoadJson || [],
        currGoodRoadJson: roads1004.currGoodRoadJson || [],
        bigRoads: roads1004.bigRoads || [],
      };

      return { tableInfo, dealerEvent, roadInfo, betInfo };
    }

    // è½»å¾®é˜²æŠ–ï¼Œåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šæ¬¡æ›´æ–°
    function schedulePush() {
      if (pushTimer) return;
      pushTimer = setTimeout(() => {
        pushTimer = null;
        pushCombined();
      }, 60); // 60ms å¯æŒ‰éœ€è°ƒæ•´
    }

    /* ======================== ä¸‹é¢æ˜¯æ–°åŠ çš„â€œæ¡Œå°å±•ç¤º DEMOâ€ ======================== */

    const DEALER_IMG_HOST =
      "https://new-dd-cloudfront.ywjxi.com/vd/vd/image/Image/dealer/";

    const EVENT_STATUS_TEXT = {
      GP_NEW_GAME_START: "æ–°å±€å¼€å§‹ / ä¸‹æ³¨ä¸­",
      GP_BETTING: "ä¸‹æ³¨ä¸­",
      GP_DEALING: "å‘ç‰Œä¸­",
      GP_SETTLEMENT: "ç»“ç®—ä¸­",
      GP_RESULT: "ç»“æœå±•ç¤º",
    };

    function resolveStatus(tableInfo = {}, dealerEvent = {}) {
      if (tableInfo.maintenance) {
        return {
          text: "ç»´æŠ¤ä¸­",
          className: "status-pill status-pill--maintenance",
        };
      }
      if (dealerEvent.shuffle || tableInfo.shuffle) {
        return {
          text: "æ´—ç‰Œä¸­",
          className: "status-pill status-pill--shuffle",
        };
      }
      const t =
        EVENT_STATUS_TEXT[dealerEvent.eventType] ||
        dealerEvent.eventType ||
        "æœªçŸ¥çŠ¶æ€";
      return { text: t, className: "status-pill" };
    }

    // road çŠ¶æ€ç æ˜ å°„ï¼ˆæ ¹æ®ä½ ç»™çš„ road å€¼ï¼‰
    function mapRoadCode(roadCode) {
      switch (roadCode) {
        case 1:
        case 6:
          return { char: "B", type: "b", pair: roadCode === 6 };
        case 2:
        case 8:
          return { char: "P", type: "p", pair: roadCode === 8 };
        case 9:
        case 10:
          return { char: "T", type: "t", pair: roadCode === 10 };
        default:
          return { char: "", type: "empty", pair: false };
      }
    }

    function renderRoadGrid(container, roadInfo = {}) {
      container.innerHTML = "";
      const bigRoads = roadInfo.bigRoads || [];
      if (!bigRoads.length) {
        container.textContent = "æš‚æ— è·¯çº¸æ•°æ®";
        return;
      }

      const maxX = bigRoads.reduce(
        (m, r) => Math.max(m, r.showX),
        0
      );
      const maxY = bigRoads.reduce(
        (m, r) => Math.max(m, r.showY),
        0
      );
      const cols = maxX + 1;
      const rows = maxY + 1;

      container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      container.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

      // å¡«ç©ºæ ¼
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const cell = document.createElement("div");
          cell.className = "road-cell empty";
          container.appendChild(cell);
        }
      }

      bigRoads.forEach((item) => {
        const { showX, showY, road } = item;
        const idx = showY * cols + showX;
        const cell = container.children[idx];
        if (!cell) return;
        const mapped = mapRoadCode(road);
        cell.className = `road-cell ${mapped.type}${mapped.pair ? " pair" : ""
          }`;
        cell.textContent = mapped.char;
      });
    }

    function createTableCardRoot() {
      const root = document.createElement("div");
      root.className = "table-card";

      const header = document.createElement("div");
      header.className = "header";
      header.innerHTML = `
          <div class="header-left">
            <span class="game-tag">Baccarat</span>
            <span class="table-name" data-table-name></span>
            <span style="font-size:11px;color:#9ca3af;" data-table-id></span>
          </div>
          <div class="header-right">
            <span><strong>Shoe</strong><span data-shoe></span></span>
            <span><strong>Round</strong><span data-round></span></span>
          </div>
        `;

      const road = document.createElement("div");
      road.className = "road";
      road.innerHTML = `
          <div class="road-title">
            <span>å¤§è·¯</span>
            <div class="road-stats">
              <span><span class="dot-b"></span>B:<span data-b-count>0</span></span>
              <span><span class="dot-p"></span>P:<span data-p-count>0</span></span>
              <span><span class="dot-t"></span>T:<span data-t-count>0</span></span>
            </div>
          </div>
          <div class="road-grid" data-road-grid></div>
        `;

      const dealer = document.createElement("div");
      dealer.className = "dealer";
      dealer.innerHTML = `
          <div class="dealer-img-wrap">
            <img class="dealer-img" data-dealer-img />
          </div>
          <div class="dealer-name" data-dealer-name></div>
          <div><span class="status-pill" data-status></span></div>
        `;

      const footer = document.createElement("div");
      footer.className = "footer";
      footer.innerHTML = `
          <div class="footer-left">
            <span><strong>æ€»æŠ•æ³¨</strong><span data-bet-amount>0</span></span>
            <span><strong>ä¸‹æ³¨äººæ•°</strong><span data-bet-count>0</span></span>
          </div>
          <button class="enter-btn">Enter</button>
        `;

      root.appendChild(header);
      root.appendChild(road);
      root.appendChild(dealer);
      root.appendChild(footer);

      return root;
    }

    // ä¸»å…¥å£ï¼šç”¨ä½ ç»™çš„çœŸå®æ•°æ®æ›´æ–° UI
    // data å¯ä»¥æ˜¯å•ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°ç»„
    function updateDgTableCard(data) {
      const container = document.getElementById("dg-table-container");
      const debugEl = document.getElementById("dg-table-debug");

      // ç»Ÿä¸€æˆæ•°ç»„å¤„ç†
      const list = Array.isArray(data) ? data : [data];

      // å…ˆæ¸…ç©ºåŸæ¥çš„æ‰€æœ‰å¡ç‰‡
      container.innerHTML = "";

      const debugData = [];

      for (const item of list) {
        if (!item) continue;
        debugData.push(item);

        const card = createTableCardRoot();
        container.appendChild(card);

        const tableInfo = item.tableInfo || {};
        const dealerEvent = item.dealerEvent || {};
        const roadInfo = item.roadInfo || {};
        const betInfo = item.betInfo || {};

        card.querySelector("[data-table-name]").textContent =
          "Baccarat " + (tableInfo.tableName || "");
        card.querySelector(
          "[data-table-id]"
        ).textContent = `ID: ${tableInfo.tableID || ""}`;
        card.querySelector("[data-shoe]").textContent =
          tableInfo.gameShoe || "";
        card.querySelector("[data-round]").textContent =
          tableInfo.gameRound || "";

        const [bCount, pCount, tCount] = roadInfo.winCounts || [0, 0, 0];
        card.querySelector("[data-b-count]").textContent = bCount;
        card.querySelector("[data-p-count]").textContent = pCount;
        card.querySelector("[data-t-count]").textContent = tCount;

        renderRoadGrid(
          card.querySelector("[data-road-grid]"),
          roadInfo
        );

        const [dealerNameRaw] = (tableInfo.dealerID || "").split("/");
        card.querySelector("[data-dealer-name]").textContent =
          dealerNameRaw || tableInfo.dealerID || "";
        const imgUrl =
          DEALER_IMG_HOST + (tableInfo.dealerImage || "default.png");
        card.querySelector("[data-dealer-img]").src = imgUrl;

        const status = resolveStatus(tableInfo, dealerEvent);
        const statusEl = card.querySelector("[data-status]");
        statusEl.textContent = status.text;
        statusEl.className = status.className;

        card.querySelector("[data-bet-amount]").textContent =
          (betInfo.currentBet || 0).toFixed(1);
        card.querySelector("[data-bet-count]").textContent =
          betInfo.betCount || 0;
      }

      debugEl.textContent =
        "å½“å‰æ•°æ®å¿«ç…§:\n" + JSON.stringify(debugData, null, 2);
    }

    // æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿ä½ åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼ˆä¾‹å¦‚åœ¨æŸä¸ª WebSocket onmessage é‡Œï¼‰
    window.updateDgTableCard = updateDgTableCard;
  </script>
</body>

</html>